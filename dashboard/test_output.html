<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MFA Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2a;
      --text: #e6eefc;
      --muted: #9fb3ce;
      --accent: #6c8cff;
      --accent2: #5bd1d7;
      --accent3: #ff8ec5;
      --accent4: #f6c85f;
      --accent5: #8be28b;
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at -10% -10%, #1a2459 0%, transparent 40%), radial-gradient(900px 600px at 110% -10%, #0b5e6f 0%, transparent 40%), radial-gradient(1000px 800px at 50% 120%, #1f3a8a 0%, #0b1220 55%);
      color: var(--text)
    }

    header {
      padding: 24px 28px;
      border-bottom: 1px solid #1e2a44;
      background: linear-gradient(180deg, rgba(15, 25, 45, .85), rgba(12, 18, 35, .7));
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 10
    }

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      letter-spacing: .4px
    }

    .container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 20px
    }

    .controls {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      position: sticky;
      top: 60px;
      z-index: 9;
      background: linear-gradient(180deg, rgba(10, 16, 28, .75), rgba(10, 16, 28, .55));
      backdrop-filter: blur(6px);
      padding: 8px 8px;
      border-radius: 12px;
      border: 1px solid #1c2946
    }

    .control {
      background: linear-gradient(180deg, rgba(28, 40, 70, .6), rgba(20, 30, 54, .6));
      border: 1px solid #263355;
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 6px 20px rgba(8, 15, 30, .25) inset
    }

    label {
      color: var(--muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .5px
    }

    select {
      appearance: none;
      background: #0f172a;
      color: var(--text);
      border: 1px solid #2c3c66;
      border-radius: 10px;
      padding: 10px 12px;
      min-width: 200px
    }

    select:focus {
      outline: 2px solid #325799
    }

    button {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      color: #0b1220;
      font-weight: 700;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      box-shadow: 0 6px 14px rgba(20, 80, 200, .35)
    }

    button:hover {
      filter: brightness(1.05)
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px
    }

    .card {
      background: linear-gradient(180deg, rgba(26, 37, 66, .86), rgba(18, 26, 42, .9));
      border: 1px solid #223154;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(6, 12, 22, .35);
      transition: transform .18s ease, box-shadow .18s ease
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 40px rgba(8, 16, 30, .45)
    }

    .card h2 {
      margin: 0 0 12px 0;
      font-size: 16px;
      background: linear-gradient(90deg, #6c8cff, #5bd1d7, #ff8ec5);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    thead th {
      position: sticky;
      top: 0;
      background: rgba(18, 26, 42, .95)
    }

    th,
    td {
      padding: 10px 10px;
      border-bottom: 1px solid #223154
    }

    tbody tr:nth-child(odd) {
      background: rgba(18, 26, 42, .35)
    }

    tbody tr:hover {
      background: rgba(35, 53, 90, .45)
    }

    th {
      color: var(--muted);
      text-align: left;
      font-weight: 700;
      cursor: pointer;
      user-select: none
    }

    th.sort-asc::after {
      content: " \25B2"
    }

    th.sort-desc::after {
      content: " \25BC"
    }

    .pill {
      display: inline-block;
      background: #16233d;
      border: 1px solid #26406b;
      color: var(--text);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px
    }

    footer {
      margin: 24px 0 40px;
      color: var(--muted);
      text-align: center;
      font-size: 12px
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin: 16px 0
    }

    @media (max-width: 1100px) {
      .charts {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 720px) {
      .charts {
        grid-template-columns: 1fr;
      }
    }

    .tabs {
      position: relative;
      display: inline-flex;
      gap: 10px;
      padding: 6px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(28, 40, 70, .5), rgba(20, 30, 54, .5));
      border: 1px solid #273351
    }

    .tab-btn {
      position: relative;
      border: none;
      padding: 12px 20px;
      border-radius: 999px;
      font-weight: 700;
      color: var(--text);
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      transition: all .2s ease
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #0b1220;
      box-shadow: 0 6px 14px rgba(20, 80, 200, .35)
    }

    .tab-btn:focus {
      outline: 2px solid #325799;
      outline-offset: 2px
    }

    .tab-indicator {
      position: absolute;
      bottom: 6px;
      height: 3px;
      border-radius: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: transform .2s ease, width .2s ease
    }

    /* Enhanced styling for primary analysis tabs */
    .primary-tabs {
      margin-bottom: 20px;
      padding: 8px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(28, 40, 70, .7), rgba(20, 30, 54, .7));
      border: 1px solid #2c3c66
    }

    .primary-tabs .tab-btn {
      padding: 14px 24px;
      font-size: 15px;
      font-weight: 700;
      margin: 0 4px
    }

    .primary-tabs .tab-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      transform: translateY(-1px)
    }
  </style>
</head>

<body>
  <header>
    <h1>Mutual Fund Analysis Dashboard</h1>
  </header>
  <div class="container">

    <!-- PRIMARY ANALYSIS TYPE TABS -->
    <div class="control primary-tabs">
      <div class="tabs" id="analysisTypeTabs">
        <!-- Dynamic analysis type tabs will be inserted here -->
        <div class="tab-indicator" id="analysisTypeIndicator"></div>
      </div>
    </div>

    <!-- CONTROLS SECTION -->
    <div class="controls">
      <div class="control">
        <div>
          <label for="dateSel">Date</label><br>
          <select id="dateSel"></select>
        </div>
      </div>
      <div class="control" id="categoryControl" style="display:none;">
        <div>
          <label for="catSel">Category</label><br>
          <select id="catSel"></select>
        </div>
      </div>
      <div class="control"><button id="loadBtn">Load</button></div>
      <div class="control"><span id="meta" class="pill">â€”</span></div>
    </div>

    <!-- SUB-TABS FOR ANALYSIS/FUNDS VIEW -->
    <div class="control" style="margin-bottom:10px;">
      <div class="tabs" id="subTabs">
        <button id="tabAnalysis" class="tab-btn active" aria-selected="true">Analysis</button>
        <button id="tabFunds" class="tab-btn" aria-selected="false">Funds</button>
        <div class="tab-indicator" id="tabIndicator"></div>
      </div>
    </div>

    <!-- Holdings Analysis Panels -->
    <div id="holdingsAnalysisPanel" class="analysis-panel">
      <div class="charts">
        <div class="card">
          <h2>Top 5 by Fund Count</h2>
          <canvas id="chartCount" height="220"></canvas>
        </div>
        <div class="card">
          <h2>Top 5 by Total Weight</h2>
          <canvas id="chartWeight" height="220"></canvas>
        </div>
        <div id="commonCard" class="card full" style="display:block;">
          <h2>Common In All Funds</h2>
          <canvas id="chartCommon" height="180"></canvas>
          <div id="commonEmpty" style="display:none;color:var(--muted);padding:10px 0;">No common stocks found across
            all funds.</div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Top by Fund Count</h2>
          <table id="byCount">
            <thead>
              <tr>
                <th data-key="company">Company</th>
                <th data-key="fund_count">Funds</th>
                <th data-key="total_weight">Total %</th>
                <th data-key="avg_weight">Avg %</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h2>Top by Total Weight</h2>
          <table id="byWeight">
            <thead>
              <tr>
                <th data-key="company">Company</th>
                <th data-key="fund_count">Funds</th>
                <th data-key="total_weight">Total %</th>
                <th data-key="avg_weight">Avg %</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Portfolio Analysis Panels -->
    <div id="portfolioAnalysisPanel" class="analysis-panel" style="display:none;">
      <!-- Portfolio Summary Cards -->
      <div class="charts">
        <div class="card">
          <h2>Portfolio Summary</h2>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin:16px 0;">
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:700;color:var(--accent);" id="portfolioTotalValue">â‚¹0</div>
              <div style="color:var(--muted);font-size:12px;">Total Value</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:700;color:var(--accent2);" id="portfolioFundCount">0</div>
              <div style="color:var(--muted);font-size:12px;">Funds</div>
            </div>
            <div style="text-align:center;">
              <div style="font-size:24px;font-weight:700;color:var(--accent3);" id="portfolioCompanyCount">0</div>
              <div style="color:var(--muted);font-size:12px;">Companies</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Fund Distribution</h2>
          <canvas id="portfolioFundChart" height="200"></canvas>
        </div>
        <div class="card">
          <h2>Top Company Allocations</h2>
          <canvas id="portfolioCompanyChart" height="200"></canvas>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Your Funds</h2>
          <table id="portfolioFunds">
            <thead>
              <tr>
                <th>Fund Name</th>
                <th>Units</th>
                <th>NAV</th>
                <th>Value (â‚¹)</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="card">
          <h2>Company Allocations</h2>
          <table id="portfolioCompanies">
            <thead>
              <tr>
                <th data-key="company_name">Company</th>
                <th data-key="amount">Amount (â‚¹)</th>
                <th data-key="percentage">Portfolio %</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Holdings Funds Panel -->
    <div id="holdingsFundsPanel" class="funds-panel">
      <div class="card">
        <h2>Funds Composition (Top 10)</h2>
        <div id="fundsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px"></div>
      </div>
    </div>

    <!-- Portfolio Funds Panel -->
    <div id="portfolioFundsPanel" class="funds-panel" style="display:none;">
      <div class="card">
        <h2>Portfolio Funds Breakdown</h2>
        <div id="portfolioFundsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px"></div>
      </div>
    </div>

    <div id="holdingsFundsListCard" class="card" style="margin-top:16px;">
      <h2>Funds</h2>
      <table id="fundsTbl">
        <thead>
          <tr>
            <th>Fund</th>
            <th>AUM</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <footer>Built with FastAPI + vanilla JS â€¢ Â©</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // ==================== UTILITY FUNCTIONS ====================
    async function getJSON(url) { const r = await fetch(url); if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); }
    function fmt(x) { return typeof x === 'number' ? x.toFixed(2) : x; }
    function opt(el, v, text = null) { const o = document.createElement('option'); o.value = v; o.textContent = text || v; el.appendChild(o); }
    function formatCurrency(value) { return `â‚¹${value.toLocaleString('en-IN')}`; }

    // ==================== GLOBAL STATE ====================
    const PALETTE = ["#6c8cff", "#5bd1d7", "#ff8ec5", "#f6c85f", "#8be28b", "#b892ff", "#ffa25e"];
    let currentAnalysisType = 'holdings';
    let availableAnalysisTypes = [];
    let analysisData = {};
    let fundsData = {};
    let charts = { holdings: {}, portfolio: {} };

    // Holdings-specific state (legacy compatibility)
    let dataByCount = []; let dataByWeight = []; let commonAll = [];
    let sortState = { byCount: { key: 'fund_count', dir: 'desc' }, byWeight: { key: 'total_weight', dir: 'desc' } };

    // ==================== INITIALIZATION ====================
    async function loadDates() {
      const res = await getJSON('/api/dates');
      const sel = document.getElementById('dateSel');
      sel.innerHTML = '';
      res.dates.slice().reverse().forEach(d => opt(sel, d));
      if (sel.value) {
        await loadAnalysisTypes();
        await loadData();
      }
    }

    async function loadAnalysisTypes() {
      const date = document.getElementById('dateSel').value;
      if (!date) return;

      const res = await getJSON(`/api/analysis-types?date=${encodeURIComponent(date)}`);
      availableAnalysisTypes = res.analysis_types || [];

      // Build primary analysis type tabs
      const tabsContainer = document.getElementById('analysisTypeTabs');
      const indicator = document.getElementById('analysisTypeIndicator');

      // Clear existing tabs (keep indicator)
      while (tabsContainer.firstChild && tabsContainer.firstChild !== indicator) {
        tabsContainer.removeChild(tabsContainer.firstChild);
      }

      // Add new tabs
      availableAnalysisTypes.forEach((type, index) => {
        const tab = document.createElement('button');
        tab.className = `tab-btn ${index === 0 ? 'active' : ''}`;
        tab.textContent = `${type.icon} ${type.display_name}`;
        tab.setAttribute('data-analysis-type', type.type);
        tab.setAttribute('aria-selected', index === 0 ? 'true' : 'false');

        tab.addEventListener('click', () => switchAnalysisType(type.type));

        tabsContainer.insertBefore(tab, indicator);
      });

      // Set default analysis type - preserve current selection if available
      let targetAnalysisType = currentAnalysisType;
      if (availableAnalysisTypes.length > 0) {
        // Check if current selection is still available
        const currentStillAvailable = availableAnalysisTypes.find(t => t.type === currentAnalysisType);
        if (!currentStillAvailable) {
          // Current type not available, fall back to first available
          targetAnalysisType = availableAnalysisTypes[0].type;
        }

        // Update currentAnalysisType and UI
        currentAnalysisType = targetAnalysisType;

        // Update tab active states
        document.querySelectorAll("#analysisTypeTabs .tab-btn").forEach(tab => {
          const isActive = tab.getAttribute("data-analysis-type") === currentAnalysisType;
          tab.classList.toggle("active", isActive);
          tab.setAttribute("aria-selected", isActive ? "true" : "false");
        });

        await updateCategoryControl();
        updateAnalysisTypeIndicator();
      }
    }

    async function switchAnalysisType(analysisType) {
      currentAnalysisType = analysisType;

      // Update active tab
      document.querySelectorAll('#analysisTypeTabs .tab-btn').forEach(tab => {
        const isActive = tab.getAttribute('data-analysis-type') === analysisType;
        tab.classList.toggle('active', isActive);
        tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });

      updateAnalysisTypeIndicator();
      await updateCategoryControl();
      await loadData();
    }

    function updateAnalysisTypeIndicator() {
      const activeTab = document.querySelector('#analysisTypeTabs .tab-btn.active');
      const indicator = document.getElementById('analysisTypeIndicator');
      const tabsContainer = document.getElementById('analysisTypeTabs');

      if (activeTab && indicator) {
        const rect = activeTab.getBoundingClientRect();
        const tabsRect = tabsContainer.getBoundingClientRect();
        indicator.style.width = rect.width + 'px';
        indicator.style.transform = `translateX(${rect.left - tabsRect.left}px)`;
      }
    }

    async function updateCategoryControl() {
      const categoryControl = document.getElementById('categoryControl');
      const catSel = document.getElementById('catSel');

      const typeInfo = availableAnalysisTypes.find(t => t.type === currentAnalysisType);

      if (typeInfo && typeInfo.requires_category) {
        // Show category control and load categories
        categoryControl.style.display = 'block';
        const date = document.getElementById('dateSel').value;
        const res = await getJSON(`/api/categories?date=${encodeURIComponent(date)}&analysis_type=${encodeURIComponent(currentAnalysisType)}`);

        catSel.innerHTML = '';
        res.categories.forEach(c => opt(catSel, c));
      } else {
        // Hide category control
        categoryControl.style.display = 'none';
        catSel.innerHTML = '';
      }
    }

    // ==================== DATA LOADING ====================
    async function loadData() {
      const date = document.getElementById('dateSel').value;
      const category = document.getElementById('catSel').value;

      if (!date || !currentAnalysisType) return;

      try {
        // Load analysis data
        let dataUrl = `/api/data?date=${encodeURIComponent(date)}&analysis_type=${encodeURIComponent(currentAnalysisType)}`;
        if (category) dataUrl += `&category=${encodeURIComponent(category)}`;

        analysisData = await getJSON(dataUrl);

        // Load funds data
        let fundsUrl = `/api/funds?date=${encodeURIComponent(date)}&analysis_type=${encodeURIComponent(currentAnalysisType)}`;
        if (category) fundsUrl += `&category=${encodeURIComponent(category)}`;

        fundsData = await getJSON(fundsUrl);

        // Update UI based on analysis type
        updateAnalysisDisplay();
        updateMetaInfo();

      } catch (error) {
        console.error('Failed to load data:', error);
      }
    }

    function updateMetaInfo() {
      const meta = document.getElementById('meta');

      if (currentAnalysisType === 'holdings') {
        const totalFunds = analysisData.total_funds || 0;
        const uniqueCompanies = analysisData.unique_companies || 0;
        meta.textContent = `${totalFunds} funds â€¢ ${uniqueCompanies} companies`;
      } else if (currentAnalysisType === 'portfolio') {
        const summary = analysisData.summary || {};
        const totalValue = summary.total_value || 0;
        const fundCount = summary.fund_count || 0;
        meta.textContent = `${formatCurrency(totalValue)} â€¢ ${fundCount} funds`;
      }
    }

    function updateAnalysisDisplay() {
      // Hide all analysis panels
      document.querySelectorAll('.analysis-panel').forEach(panel => {
        panel.style.display = 'none';
      });

      // Show current analysis panel
      const currentPanel = document.getElementById(`${currentAnalysisType}AnalysisPanel`);
      if (currentPanel) {
        currentPanel.style.display = 'block';
      }

      // Render analysis-specific content
      if (currentAnalysisType === 'holdings') {
        renderHoldingsAnalysis();
      } else if (currentAnalysisType === 'portfolio') {
        renderPortfolioAnalysis();
        }
        
        // Show/hide bottom funds list (only for holdings)
        const holdingsFundsListCard = document.getElementById("holdingsFundsListCard");
        if (holdingsFundsListCard) {
          holdingsFundsListCard.style.display = currentAnalysisType === "holdings" ? "block" : "none";
        }
      }

      // Update funds panel for current sub-tab
      updateFundsDisplay();
    }

    // ==================== HOLDINGS ANALYSIS ====================
    function renderHoldingsAnalysis() {
      // Legacy holdings logic
      dataByCount = analysisData.top_by_fund_count?.slice(0, 100) || [];
      dataByWeight = analysisData.top_by_total_weight?.slice(0, 100) || [];
      commonAll = Array.isArray(analysisData.common_in_all_funds) ? analysisData.common_in_all_funds : [];

      renderHoldingsTables();
      renderHoldingsCharts();
      renderCommonChart();
      renderFundsList();
    }

    function renderHoldingsTables() {
      const { key: kC, dir: dC } = sortState.byCount;
      const { key: kW, dir: dW } = sortState.byWeight;
      const cmp = (k, dir) => (a, b) => { const A = a[k], B = b[k]; const an = typeof A === 'number' ? A : (parseFloat(A) || A); const bn = typeof B === 'number' ? B : (parseFloat(B) || B); if (an < bn) return dir === 'asc' ? -1 : 1; if (an > bn) return dir === 'asc' ? 1 : -1; return 0; };
      const bc = [...dataByCount].sort(cmp(kC, dC)).slice(0, 25);
      const bw = [...dataByWeight].sort(cmp(kW, dW)).slice(0, 25);

      const byC = document.querySelector('#byCount tbody'); byC.innerHTML = '';
      bc.forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.company}</td><td>${r.fund_count}</td><td>${fmt(r.total_weight)}</td><td>${fmt(r.avg_weight)}</td>`; byC.appendChild(tr); });

      const byW = document.querySelector('#byWeight tbody'); byW.innerHTML = '';
      bw.forEach(r => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${r.company}</td><td>${r.fund_count}</td><td>${fmt(r.total_weight)}</td><td>${fmt(r.avg_weight)}</td>`; byW.appendChild(tr); });

      updateSortIndicators();
    }

    function renderHoldingsCharts() {
      const topC = [...dataByCount].sort((a, b) => b.fund_count - a.fund_count).slice(0, 5);
      const topW = [...dataByWeight].sort((a, b) => b.total_weight - a.total_weight).slice(0, 5);
      const labelsC = topC.map(r => r.company); const dataC = topC.map(r => r.fund_count);
      const labelsW = topW.map(r => r.company); const dataW = topW.map(r => r.total_weight);

      const ctxC = document.getElementById('chartCount'); const ctxW = document.getElementById('chartWeight');
      if (charts.holdings.count) charts.holdings.count.destroy();
      if (charts.holdings.weight) charts.holdings.weight.destroy();

      charts.holdings.count = new Chart(ctxC, { type: 'bar', data: { labels: labelsC, datasets: [{ label: 'Funds', data: dataC, backgroundColor: PALETTE }] }, options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#223154' } }, y: { grid: { display: false } } } } });
      charts.holdings.weight = new Chart(ctxW, { type: 'bar', data: { labels: labelsW, datasets: [{ label: 'Total %', data: dataW, backgroundColor: PALETTE }] }, options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#223154' } }, y: { grid: { display: false } } } } });
    }

    function renderCommonChart() {
      const wrap = document.getElementById('commonCard');
      const empty = document.getElementById('commonEmpty');
      wrap.style.display = 'block';

      if (!commonAll || commonAll.length === 0) {
        empty.style.display = 'block';
        if (charts.holdings.common) { charts.holdings.common.destroy(); charts.holdings.common = null; }
        return;
      }

      empty.style.display = 'none';
      const top = [...commonAll].sort((a, b) => b.total_weight - a.total_weight).slice(0, 5);
      const labels = top.map(r => r.company);
      const data = top.map(r => r.total_weight);
      const ctx = document.getElementById('chartCommon');

      if (!window.Chart || !ctx) { wrap.style.display = 'none'; return; }

      try {
        if (charts.holdings.common) charts.holdings.common.destroy();
        const bg = data.map((_, i) => PALETTE[i % PALETTE.length]);
        charts.holdings.common = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Total %', data, backgroundColor: bg }] }, options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#223154' } }, y: { grid: { display: false } } } } });
      } catch (e) {
        console.error(e);
        wrap.style.display = 'none';
        if (charts.holdings.common) { charts.holdings.common.destroy(); charts.holdings.common = null; }
      }
    }

    function renderFundsList() {
      const funds = document.querySelector('#fundsTbl tbody'); funds.innerHTML = '';
      (analysisData.funds || []).forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${f.name}</td><td>${f.aum || ''}</td>`;
        funds.appendChild(tr);
      });
    }

    // ==================== PORTFOLIO ANALYSIS ====================
    function renderPortfolioAnalysis() {
      const summary = analysisData.summary || {};
      const chartData = analysisData.charts || {};

      // Update summary cards
      document.getElementById('portfolioTotalValue').textContent = formatCurrency(summary.total_value || 0);
      document.getElementById('portfolioFundCount').textContent = summary.fund_count || 0;
      document.getElementById('portfolioCompanyCount').textContent = summary.unique_companies || 0;

      // Render charts
      renderPortfolioCharts(chartData);

      // Render tables
      renderPortfolioTables();
    }

    function renderPortfolioCharts(chartData) {
      const fundDistribution = chartData.fund_distribution || [];
      const topCompanies = chartData.top_companies || [];

      // Fund distribution pie chart
      const fundCtx = document.getElementById('portfolioFundChart');
      if (charts.portfolio.funds) charts.portfolio.funds.destroy();

      if (fundDistribution.length > 0) {
        charts.portfolio.funds = new Chart(fundCtx, {
          type: 'doughnut',
          data: {
            labels: fundDistribution.map(f => f.name),
            datasets: [{
              data: fundDistribution.map(f => f.value),
              backgroundColor: PALETTE.slice(0, fundDistribution.length)
            }]
          },
          options: {
            plugins: { legend: { position: 'bottom' } }
          }
        });
      }

      // Top companies bar chart
      const companyCtx = document.getElementById('portfolioCompanyChart');
      if (charts.portfolio.companies) charts.portfolio.companies.destroy();

      if (topCompanies.length > 0) {
        charts.portfolio.companies = new Chart(companyCtx, {
          type: 'bar',
          data: {
            labels: topCompanies.map(c => c.name),
            datasets: [{
              label: 'Amount (â‚¹)',
              data: topCompanies.map(c => c.amount),
              backgroundColor: PALETTE.slice(0, topCompanies.length)
            }]
          },
          options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { color: '#223154' } },
              y: { grid: { display: false } }
            }
          }
        });
      }
    }

    function renderPortfolioTables() {
      const funds = analysisData.funds || [];
      const companies = analysisData.company_allocations || [];
      const totalValue = analysisData.summary?.total_value || 1;

      // Render funds table
      const fundsTable = document.querySelector('#portfolioFunds tbody');
      fundsTable.innerHTML = '';
      funds.forEach(fund => {
        const percentage = totalValue > 0 ? ((fund.value / totalValue) * 100).toFixed(2) : '0.00';
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${fund.fund_name}</td>
            <td>${fund.units}</td>
            <td>â‚¹${fund.nav}</td>
            <td>${formatCurrency(fund.value)}</td>
            <td>${percentage}%</td>
          `;
        fundsTable.appendChild(tr);
      });

      // Render companies table
      const companiesTable = document.querySelector('#portfolioCompanies tbody');
      companiesTable.innerHTML = '';
      companies.slice(0, 50).forEach(company => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${company.company_name}</td>
            <td>${formatCurrency(company.amount)}</td>
            <td>${company.percentage}%</td>
          `;
        companiesTable.appendChild(tr);
      });
    }

    // ==================== TAB MANAGEMENT ====================
    function updateFundsDisplay() {
      // Hide all funds panels
      document.querySelectorAll('.funds-panel').forEach(panel => {
        panel.style.display = 'none';
      });

      // Show current analysis funds panel if "Funds" tab is active
      const fundsTabActive = document.getElementById('tabFunds').classList.contains('active');
      if (fundsTabActive) {
        const currentFundsPanel = document.getElementById(`${currentAnalysisType}FundsPanel`);
        if (currentFundsPanel) {
          currentFundsPanel.style.display = 'block';

          // Render funds composition based on analysis type
          if (currentAnalysisType === 'holdings') {
            renderHoldingsFunds();
          } else if (currentAnalysisType === 'portfolio') {
            renderPortfolioFunds();
        }
        
        // Hide bottom funds list when in funds tab (redundant with funds panels)
        const holdingsFundsListCard = document.getElementById("holdingsFundsListCard");
        if (holdingsFundsListCard) {
          holdingsFundsListCard.style.display = "none";
        }
          }
        }
      }
    }

    function renderHoldingsFunds() {
      const grid = document.getElementById('fundsGrid');
      grid.innerHTML = '';
      const funds = fundsData.funds || [];

      funds.forEach((fund, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        const id = `fund_${idx}`;
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-weight:700">${fund.fund_name}</div><div class="pill">${fund.aum || ''}</div></div><canvas id="${id}" height="130"></canvas>`;
        grid.appendChild(card);

        const labels = fund.holdings.map(h => h.company);
        const data = fund.holdings.map(h => h.weight);
        const ctx = document.getElementById(id);
        new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '% Weight', data, backgroundColor: labels.map((_, i) => PALETTE[i % PALETTE.length]) }] }, options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#223154' }, stacked: false, max: 10, ticks: { stepSize: 1 } }, y: { grid: { display: false } } } } });
      });
    }

    function renderPortfolioFunds() {
      const grid = document.getElementById('portfolioFundsGrid');
      grid.innerHTML = '';
      const funds = fundsData.funds || [];

      funds.forEach((fund, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        const id = `portfolio_fund_${idx}`;
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-weight:700">${fund.fund_name}</div><div class="pill">NAV: â‚¹${fund.nav}</div></div><canvas id="${id}" height="130"></canvas>`;
        grid.appendChild(card);

        const labels = fund.holdings.map(h => h.company);
        const data = fund.holdings.map(h => h.percentage);
        const ctx = document.getElementById(id);
        new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '% Allocation', data, backgroundColor: labels.map((_, i) => PALETTE[i % PALETTE.length]) }] }, options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#223154' }, stacked: false, max: 15, ticks: { stepSize: 2 } }, y: { grid: { display: false } } } } });
      });
    }

    function setActiveSubTab(which) {
      const a = document.getElementById('tabAnalysis');
      const f = document.getElementById('tabFunds');
      const ind = document.getElementById('tabIndicator');
      const target = which === 'funds' ? f : a;

      a.classList.toggle('active', which !== 'funds');
      f.classList.toggle('active', which === 'funds');
      a.setAttribute('aria-selected', which !== 'funds');
      f.setAttribute('aria-selected', which === 'funds');

      // Show/hide panels based on active tab
      if (which === "funds") {
        // Hide all analysis panels
        document.querySelectorAll(".analysis-panel").forEach(panel => {
          panel.style.display = "none";
        });
        
        // Show only current analysis funds panel
        const currentFundsPanel = document.getElementById(`${currentAnalysisType}FundsPanel`);
        if (currentFundsPanel) {
          currentFundsPanel.style.display = "block";
          
          // Render funds composition based on analysis type
          if (currentAnalysisType === "holdings") {
            renderHoldingsFunds();
          } else if (currentAnalysisType === "portfolio") {
            renderPortfolioFunds();
        }
        
        // Hide bottom funds list when in funds tab (redundant with funds panels)
        const holdingsFundsListCard = document.getElementById("holdingsFundsListCard");
        if (holdingsFundsListCard) {
          holdingsFundsListCard.style.display = "none";
        }
          }
        }
        
        // Hide all other funds panels
        document.querySelectorAll(".funds-panel").forEach(panel => {
          if (panel.id !== `${currentAnalysisType}FundsPanel`) {
            panel.style.display = "none";
          }
        });
      } else {
        // Hide all funds panels
        document.querySelectorAll(".funds-panel").forEach(panel => {
          panel.style.display = "none";
        });
        
        // Show current analysis panel
        document.querySelectorAll(".analysis-panel").forEach(panel => {
          panel.style.display = "none";
        });
        
        const currentPanel = document.getElementById(`${currentAnalysisType}AnalysisPanel`);
        if (currentPanel) {
          currentPanel.style.display = "block";
        }
        
        // Render analysis-specific content
        if (currentAnalysisType === "holdings") {
          renderHoldingsAnalysis();
        } else if (currentAnalysisType === "portfolio") {
          renderPortfolioAnalysis();
        }
        
        // Show/hide bottom funds list (only for holdings)
        const holdingsFundsListCard = document.getElementById("holdingsFundsListCard");
        if (holdingsFundsListCard) {
          holdingsFundsListCard.style.display = currentAnalysisType === "holdings" ? "block" : "none";
        }
        }
      }

      // Move indicator
      const tabs = document.getElementById('subTabs');
      const rect = target.getBoundingClientRect();
      const tabsRect = tabs.getBoundingClientRect();
      ind.style.width = rect.width + 'px';
      ind.style.transform = `translateX(${rect.left - tabsRect.left}px)`;
    }

    // ==================== SORTING (Holdings) ====================
    function updateSortIndicators() {
      document.querySelectorAll('#byCount th, #byWeight th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
      const thC = document.querySelector(`#byCount th[data-key="${sortState.byCount.key}"]`); if (thC) thC.classList.add(sortState.byCount.dir === 'asc' ? 'sort-asc' : 'sort-desc');
      const thW = document.querySelector(`#byWeight th[data-key="${sortState.byWeight.key}"]`); if (thW) thW.classList.add(sortState.byWeight.dir === 'asc' ? 'sort-asc' : 'sort-desc');
    }

    function attachSorting() {
      document.querySelectorAll('#byCount th').forEach(th => {
        th.addEventListener('click', () => { const k = th.dataset.key; const cur = sortState.byCount; cur.dir = (cur.key === k && cur.dir === 'asc') ? 'desc' : 'asc'; cur.key = k; renderHoldingsTables(); });
      });
      document.querySelectorAll('#byWeight th').forEach(th => {
        th.addEventListener('click', () => { const k = th.dataset.key; const cur = sortState.byWeight; cur.dir = (cur.key === k && cur.dir === 'asc') ? 'desc' : 'asc'; cur.key = k; renderHoldingsTables(); });
      });
    }

    // ==================== EVENT LISTENERS ====================
    document.getElementById('dateSel').addEventListener('change', async () => {
      await loadAnalysisTypes();
      await loadData();
    });

    document.getElementById('catSel').addEventListener('change', loadData);
    document.getElementById('loadBtn').addEventListener('click', loadData);

    // Sub-tab navigation
    document.getElementById('tabAnalysis').addEventListener('click', () => setActiveSubTab('analysis'));
    document.getElementById('tabFunds').addEventListener('click', () => setActiveSubTab('funds'));

    // Responsive indicator adjustment
    window.addEventListener('resize', () => {
      const fActive = document.getElementById('tabFunds').classList.contains('active');
      setActiveSubTab(fActive ? 'funds' : 'analysis');
      updateAnalysisTypeIndicator();
    });

    // ==================== INITIALIZATION ====================
    attachSorting();
    window.requestAnimationFrame(() => setActiveSubTab('analysis'));
    loadDates().then(() => loadData()).catch(console.error);
  </script>
</body>

</html>