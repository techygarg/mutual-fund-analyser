<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MFA Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
      :root { --bg: #0b1220; --card:#121a2a; --text:#e6eefc; --muted:#9fb3ce; --accent:#6c8cff; --accent2:#5bd1d7; --accent3:#ff8ec5; --accent4:#f6c85f; --accent5:#8be28b; }
      *{box-sizing:border-box}
      body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 600px at -10% -10%, #1a2459 0%, transparent 40%), radial-gradient(900px 600px at 110% -10%, #0b5e6f 0%, transparent 40%), radial-gradient(1000px 800px at 50% 120%, #1f3a8a 0%, #0b1220 55%);color:var(--text)}
      header{padding:24px 28px;border-bottom:1px solid #1e2a44;background:linear-gradient(180deg, rgba(15,25,45,.85), rgba(12,18,35,.7));backdrop-filter: blur(8px);position:sticky;top:0;z-index:10}
      h1{margin:0;font-size:20px;font-weight:600;letter-spacing:.4px}
      .container{max-width:1200px;margin:24px auto;padding:0 20px}
      .controls{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;position:sticky;top:60px;z-index:9;background:linear-gradient(180deg, rgba(10,16,28,.75), rgba(10,16,28,.55));backdrop-filter: blur(6px);padding:8px 8px;border-radius:12px;border:1px solid #1c2946}
      .control{background:linear-gradient(180deg, rgba(28,40,70,.6), rgba(20,30,54,.6));border:1px solid #263355;border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow: 0 6px 20px rgba(8,15,30,.25) inset}
      label{color:var(--muted);font-size:12px;text-transform:uppercase;letter-spacing:.5px}
      select{appearance:none;background:#0f172a;color:var(--text);border:1px solid #2c3c66;border-radius:10px;padding:10px 12px;min-width:200px}
      select:focus{outline:2px solid #325799}
      button{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;color:#0b1220;font-weight:700;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow: 0 6px 14px rgba(20,80,200,.35)}
      button:hover{filter:brightness(1.05)}
      .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
      .card{background:linear-gradient(180deg, rgba(26,37,66,.86), rgba(18,26,42,.9));border:1px solid #223154;border-radius:16px;padding:16px;box-shadow: 0 10px 30px rgba(6,12,22,.35);transition:transform .18s ease, box-shadow .18s ease}
      .card:hover{transform:translateY(-2px); box-shadow: 0 14px 40px rgba(8,16,30,.45)}
      .card h2{margin:0 0 12px 0;font-size:16px;background:linear-gradient(90deg, #6c8cff, #5bd1d7, #ff8ec5);-webkit-background-clip:text;background-clip:text;color:transparent;}
      table{width:100%;border-collapse:collapse}
      thead th{position:sticky;top:0;background:rgba(18,26,42,.95)}
      th,td{padding:10px 10px;border-bottom:1px solid #223154}
      tbody tr:nth-child(odd){background:rgba(18,26,42,.35)}
      tbody tr:hover{background:rgba(35,53,90,.45)}
      th{color:var(--muted);text-align:left;font-weight:700;cursor:pointer;user-select:none}
      th.sort-asc::after{content:" \25B2"}
      th.sort-desc::after{content:" \25BC"}
      .pill{display:inline-block;background:#16233d;border:1px solid #26406b;color:var(--text);padding:2px 8px;border-radius:999px;font-size:12px}
      footer{margin:24px 0 40px;color:var(--muted);text-align:center;font-size:12px}
      .charts{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin:16px 0}
      @media (max-width: 1100px){ .charts{ grid-template-columns: repeat(2, 1fr); } }
      @media (max-width: 720px){ .charts{ grid-template-columns: 1fr; } }
      .tabs{position:relative;display:inline-flex;gap:10px;padding:6px;border-radius:999px;background:linear-gradient(180deg, rgba(28,40,70,.5), rgba(20,30,54,.5));border:1px solid #273351}
      .tab-btn{position:relative;border:none;padding:10px 16px;border-radius:999px;font-weight:700;color:var(--text);background:transparent;cursor:pointer}
      .tab-btn.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#0b1220;box-shadow:0 6px 14px rgba(20,80,200,.35)}
      .tab-btn:focus{outline:2px solid #325799;outline-offset:2px}
      .tab-indicator{position:absolute;bottom:6px;height:3px;border-radius:3px;background:linear-gradient(90deg, var(--accent), var(--accent2));transition:transform .2s ease,width .2s ease}
    </style>
  </head>
  <body>
    <header><h1>Mutual Fund Analysis Dashboard</h1></header>
    <div class="container">
      <div class="controls">
        <div class="control">
          <div>
            <label for="dateSel">Date</label><br>
            <select id="dateSel"></select>
          </div>
        </div>
        <div class="control">
          <div>
            <label for="catSel">Category</label><br>
            <select id="catSel"></select>
          </div>
        </div>
        <div class="control"><button id="loadBtn">Load</button></div>
        <div class="control"><span id="meta" class="pill">—</span></div>
      </div>

      <div class="control" style="margin-bottom:10px;">
        <div class="tabs" id="tabs">
          <button id="tabAnalysis" class="tab-btn active" aria-selected="true">Analysis</button>
          <button id="tabFunds" class="tab-btn" aria-selected="false">Funds</button>
          <div class="tab-indicator" id="tabIndicator"></div>
        </div>
      </div>

      <div id="panelAnalysis">
      <div class="charts">
        <div class="card">
          <h2>Top 5 by Fund Count</h2>
          <canvas id="chartCount" height="220"></canvas>
        </div>
        <div class="card">
          <h2>Top 5 by Total Weight</h2>
          <canvas id="chartWeight" height="220"></canvas>
        </div>
        <div id="commonCard" class="card full" style="display:block;">
          <h2>Common In All Funds</h2>
          <canvas id="chartCommon" height="180"></canvas>
          <div id="commonEmpty" style="display:none;color:var(--muted);padding:10px 0;">No common stocks found across all funds.</div>
        </div>
      </div>

      <div class="grid">
        <div class="card">
          <h2>Top by Fund Count</h2>
          <table id="byCount"><thead><tr>
            <th data-key="company">Company</th>
            <th data-key="fund_count">Funds</th>
            <th data-key="total_weight">Total %</th>
            <th data-key="avg_weight">Avg %</th>
          </tr></thead><tbody></tbody></table>
        </div>
        <div class="card">
          <h2>Top by Total Weight</h2>
          <table id="byWeight"><thead><tr>
            <th data-key="company">Company</th>
            <th data-key="fund_count">Funds</th>
            <th data-key="total_weight">Total %</th>
            <th data-key="avg_weight">Avg %</th>
          </tr></thead><tbody></tbody></table>
        </div>
      </div>
      </div>

      <div id="panelFunds" style="display:none;">
        <div class="card">
          <h2>Funds Composition (Top 10)</h2>
          <div id="fundsGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px"></div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2>Funds</h2>
        <table id="fundsTbl"><thead><tr><th>Fund</th><th>AUM</th></tr></thead><tbody></tbody></table>
      </div>

      <footer>Built with FastAPI + vanilla JS • ©</footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      async function getJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
      function fmt(x){ return typeof x==='number'? x.toFixed(2): x; }
      function opt(el, v){ const o = document.createElement('option'); o.value=o.textContent=v; el.appendChild(o); }

      const PALETTE=["#6c8cff","#5bd1d7","#ff8ec5","#f6c85f","#8be28b","#b892ff","#ffa25e"];
      let dataByCount = []; let dataByWeight = []; let commonAll = [];
      let sortState = { byCount: { key:'fund_count', dir:'desc' }, byWeight: { key:'total_weight', dir:'desc' } };
      let chartCount=null, chartWeight=null, chartCommon=null;
      let fundsCache = [];

      async function loadDates(){
        const res = await getJSON('/api/dates');
        const sel = document.getElementById('dateSel');
        sel.innerHTML='';
        res.dates.slice().reverse().forEach(d=>opt(sel,d));
        if(sel.value) await loadCategories();
      }

      async function loadCategories(){
        const date = document.getElementById('dateSel').value;
        const res = await getJSON(`/api/categories?date=${encodeURIComponent(date)}`);
        const sel = document.getElementById('catSel');
        sel.innerHTML='';
        res.categories.forEach(c=>opt(sel,c));
      }

      async function loadData(){
        const date = document.getElementById('dateSel').value;
        const cat = document.getElementById('catSel').value;
        const d = await getJSON(`/api/data?date=${encodeURIComponent(date)}&category=${encodeURIComponent(cat)}`);
        document.getElementById('meta').textContent = `${d.total_funds} funds • ${d.unique_companies} companies`;

        dataByCount = d.top_by_fund_count.slice(0,100);
        dataByWeight = d.top_by_total_weight.slice(0,100);
        commonAll = Array.isArray(d.common_in_all_funds)? d.common_in_all_funds: [];
        renderTables();
        renderCharts();
        renderCommonChart();

        const funds = document.querySelector('#fundsTbl tbody'); funds.innerHTML='';
        (d.funds||[]).forEach(f=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${f.name}</td><td>${f.aum||''}</td>`;
          funds.appendChild(tr);
        });

        // Load funds composition for Funds tab
        const f = await getJSON(`/api/funds?date=${encodeURIComponent(date)}&category=${encodeURIComponent(cat)}`);
        fundsCache = f.funds || [];
        renderFunds();
      }

      function renderTables(){
        const { key:kC, dir:dC } = sortState.byCount;
        const { key:kW, dir:dW } = sortState.byWeight;
        const cmp = (k,dir)=>(a,b)=>{const A=a[k],B=b[k]; const an=typeof A==='number'?A: (parseFloat(A)||A); const bn=typeof B==='number'?B: (parseFloat(B)||B); if(an<bn) return dir==='asc'?-1:1; if(an>bn) return dir==='asc'?1:-1; return 0;};
        const bc = [...dataByCount].sort(cmp(kC,dC)).slice(0,25);
        const bw = [...dataByWeight].sort(cmp(kW,dW)).slice(0,25);
        const byC = document.querySelector('#byCount tbody'); byC.innerHTML='';
        bc.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.company}</td><td>${r.fund_count}</td><td>${fmt(r.total_weight)}</td><td>${fmt(r.avg_weight)}</td>`; byC.appendChild(tr); });
        const byW = document.querySelector('#byWeight tbody'); byW.innerHTML='';
        bw.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.company}</td><td>${r.fund_count}</td><td>${fmt(r.total_weight)}</td><td>${fmt(r.avg_weight)}</td>`; byW.appendChild(tr); });
        updateSortIndicators();
      }

      function updateSortIndicators(){
        document.querySelectorAll('#byCount th, #byWeight th').forEach(th=> th.classList.remove('sort-asc','sort-desc'));
        const thC = document.querySelector(`#byCount th[data-key="${sortState.byCount.key}"]`); if(thC) thC.classList.add(sortState.byCount.dir==='asc'?'sort-asc':'sort-desc');
        const thW = document.querySelector(`#byWeight th[data-key="${sortState.byWeight.key}"]`); if(thW) thW.classList.add(sortState.byWeight.dir==='asc'?'sort-asc':'sort-desc');
      }

      function attachSorting(){
        document.querySelectorAll('#byCount th').forEach(th=>{
          th.addEventListener('click', ()=>{ const k=th.dataset.key; const cur=sortState.byCount; cur.dir = (cur.key===k && cur.dir==='asc')?'desc':'asc'; cur.key=k; renderTables(); });
        });
        document.querySelectorAll('#byWeight th').forEach(th=>{
          th.addEventListener('click', ()=>{ const k=th.dataset.key; const cur=sortState.byWeight; cur.dir = (cur.key===k && cur.dir==='asc')?'desc':'asc'; cur.key=k; renderTables(); });
        });
      }

      function renderCharts(){
        const topC = [...dataByCount].sort((a,b)=>b.fund_count-a.fund_count).slice(0,5);
        const topW = [...dataByWeight].sort((a,b)=>b.total_weight-a.total_weight).slice(0,5);
        const labelsC = topC.map(r=>r.company); const dataC = topC.map(r=>r.fund_count);
        const labelsW = topW.map(r=>r.company); const dataW = topW.map(r=>r.total_weight);
        const ctxC = document.getElementById('chartCount'); const ctxW = document.getElementById('chartWeight');
        if(chartCount) chartCount.destroy(); if(chartWeight) chartWeight.destroy();
        chartCount = new Chart(ctxC, { type:'bar', data:{ labels:labelsC, datasets:[{ label:'Funds', data:dataC, backgroundColor: PALETTE }] }, options:{ indexAxis:'y', plugins:{legend:{display:false}}, scales:{ x:{ grid:{color:'#223154'}}, y:{ grid:{display:false}} } } });
        chartWeight = new Chart(ctxW, { type:'bar', data:{ labels:labelsW, datasets:[{ label:'Total %', data:dataW, backgroundColor: PALETTE }] }, options:{ indexAxis:'y', plugins:{legend:{display:false}}, scales:{ x:{ grid:{color:'#223154'}}, y:{ grid:{display:false}} } } });
      }

      function renderCommonChart(){
        const wrap = document.getElementById('commonCard');
        const empty = document.getElementById('commonEmpty');
        wrap.style.display='block';
        if(!commonAll || commonAll.length===0){
          empty.style.display='block';
          if(chartCommon){ chartCommon.destroy(); chartCommon=null; }
          return;
        }
        empty.style.display='none';
        const top = [...commonAll].sort((a,b)=>b.total_weight-a.total_weight).slice(0,5);
        const labels = top.map(r=>r.company);
        const data = top.map(r=>r.total_weight);
        const ctx = document.getElementById('chartCommon');
        if(!window.Chart || !ctx){ wrap.style.display='none'; return; }
        try{
          if(chartCommon) chartCommon.destroy();
          const bg = data.map((_,i)=> PALETTE[i%PALETTE.length]);
          chartCommon = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'Total %', data, backgroundColor: bg }] }, options:{ indexAxis:'y', plugins:{legend:{display:false}}, scales:{ x:{ grid:{color:'#223154'}}, y:{ grid:{display:false}} } } });
        }catch(e){
          console.error(e);
          wrap.style.display='none';
          if(chartCommon) { chartCommon.destroy(); chartCommon=null; }
        }
      }

      function renderFunds(){
        const grid = document.getElementById('fundsGrid');
        grid.innerHTML='';
        const palette = PALETTE;
        fundsCache.forEach((fund, idx)=>{
          const card = document.createElement('div');
          card.className='card';
          const id = `fund_${idx}`;
          card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-weight:700">${fund.fund_name}</div><div class="pill">${fund.aum||''}</div></div><canvas id="${id}" height="130"></canvas>`;
          grid.appendChild(card);
          const labels = fund.holdings.map(h=>h.company);
          const data = fund.holdings.map(h=>h.weight);
          const ctx = document.getElementById(id);
          new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label:'% Weight', data, backgroundColor: labels.map((_,i)=> palette[i%palette.length]) }] }, options:{ indexAxis:'y', plugins:{legend:{display:false}}, scales:{ x:{ grid:{color:'#223154'}, stacked:false, max:10, ticks:{ stepSize:1 } }, y:{ grid:{display:false} } } } });
        });
      }

      document.getElementById('dateSel').addEventListener('change', async ()=>{ await loadCategories(); await loadData(); });
      document.getElementById('loadBtn').addEventListener('click', loadData);
      attachSorting();
      // Tabs
      function setActiveTab(which){
        const a=document.getElementById('tabAnalysis');
        const f=document.getElementById('tabFunds');
        const ind=document.getElementById('tabIndicator');
        const target = which==='funds'? f : a;
        a.classList.toggle('active', which!=='funds');
        f.classList.toggle('active', which==='funds');
        a.setAttribute('aria-selected', which!=='funds');
        f.setAttribute('aria-selected', which==='funds');
        document.getElementById('panelAnalysis').style.display = which==='funds'? 'none':'block';
        document.getElementById('panelFunds').style.display = which==='funds'? 'block':'none';
        // move indicator under active
        const tabs=document.getElementById('tabs');
        const rect= target.getBoundingClientRect();
        const tabsRect= tabs.getBoundingClientRect();
        ind.style.width = rect.width+'px';
        ind.style.transform = `translateX(${rect.left - tabsRect.left}px)`;
      }
      window.addEventListener('resize', ()=>{
        const fActive=document.getElementById('tabFunds').classList.contains('active');
        setActiveTab(fActive? 'funds':'analysis');
      });
      document.getElementById('tabAnalysis').addEventListener('click', ()=> setActiveTab('analysis'));
      document.getElementById('tabFunds').addEventListener('click', ()=> setActiveTab('funds'));
      // initialize indicator after first paint
      window.requestAnimationFrame(()=> setActiveTab('analysis'));
      loadDates().then(()=> loadData()).catch(console.error);
    </script>
  </body>
  </html>


