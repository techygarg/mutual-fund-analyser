name: CI Pipeline

# Trigger the workflow on Pull Requests and pushes to main
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

# Cancel in-progress workflows for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  
jobs:
  # Job 1: Code Quality & Linting (Fast)
  lint:
    name: "ğŸ” Code Quality & Linting"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "ğŸ Setup Python Environment"
      uses: ./.github/actions/setup-python
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: "ğŸ” Run all code quality checks"
      run: .github/scripts/check.sh

  # Job 2: Unit Tests (Fast) - Runs After Lint Passes
  unit-tests:
    name: "âš¡ Unit Tests"
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 5
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "ğŸ Setup Python Environment"
      uses: ./.github/actions/setup-python
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: "ğŸ§ª Run unit tests with coverage"
      run: .github/scripts/test-unit.sh
          
    - name: "ğŸ“Š Upload Results & Coverage"
      uses: ./.github/actions/upload-test-results
      with:
        test-type: unit
        upload-coverage: 'true'

  # Job 3: Integration Tests (Slower) - Runs After Unit Tests Pass
  integration-tests:
    name: "ğŸ­ Integration Tests"
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 10
    
    steps:
    - name: "ğŸ“¥ Checkout code"
      uses: actions/checkout@v4
      
    - name: "ğŸ Setup Python Environment with Playwright"
      uses: ./.github/actions/setup-python
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        install-playwright: 'true'
        
    - name: "ğŸ§ª Run integration tests"
      run: .github/scripts/test-integration.sh
          
    - name: "ğŸ“Š Upload Results & Artifacts"
      uses: ./.github/actions/upload-test-results
      with:
        test-type: integration
        upload-artifacts-on-failure: 'true'
        artifact-paths: |
          tests/integration/test_workspace/
          *.log

  # Job 4: Test Summary & Status Check - Runs After All Tests Complete
  test-summary:
    name: "ğŸ“‹ Test Summary"
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests]
    if: always()
    
    steps:
    - name: "âœ… All tests passed"
      if: ${{ needs.lint.result == 'success' && needs.unit-tests.result == 'success' && needs.integration-tests.result == 'success' }}
      run: |
        echo "ğŸ‰ All CI checks passed successfully!"
        echo "âœ… Code Quality: PASSED"
        echo "âœ… Unit Tests: PASSED" 
        echo "âœ… Integration Tests: PASSED"
        
    - name: "âŒ Some tests failed"
      if: ${{ needs.lint.result != 'success' || needs.unit-tests.result != 'success' || needs.integration-tests.result != 'success' }}
      run: |
        echo "âŒ Some CI checks failed!"
        echo "Code Quality: ${{ needs.lint.result }}"
        echo "Unit Tests: ${{ needs.unit-tests.result }}"
        echo "Integration Tests: ${{ needs.integration-tests.result }}"
        exit 1
