name: Main Branch Checks

# Fast workflow for development branches (not main)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

# Cancel in-progress workflows for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
  
jobs:
  # Job 1: Code Quality & Linting (Fast)
  lint:
    name: "🔍 Code Quality & Linting"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - name: "📥 Checkout code"
      uses: actions/checkout@v4
      
    - name: "🐍 Setup Python Environment"
      uses: ./.github/actions/setup-python
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: "🔍 Run all code quality checks"
      run: .github/scripts/check.sh

  # Job 2: Unit Tests (Fast) - Runs After Lint Passes
  unit-tests:
    name: "⚡ Unit Tests"
    runs-on: ubuntu-latest
    needs: lint
    timeout-minutes: 5
    
    steps:
    - name: "📥 Checkout code"
      uses: actions/checkout@v4
      
    - name: "🐍 Setup Python Environment"
      uses: ./.github/actions/setup-python
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: "🧪 Run unit tests with coverage"
      run: .github/scripts/test-unit.sh
          
    - name: "📊 Upload Results & Coverage"
      uses: ./.github/actions/upload-test-results
      with:
        test-type: unit
        upload-coverage: 'true'
